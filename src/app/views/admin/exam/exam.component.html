@if (!loading) {
  <p-confirm-dialog key="confirmDialog" />
  <app-exam-settings mode="edit" [examId]="examId" [settings]="examConfig"></app-exam-settings>
  <app-usage-chart [examId]="examId" />
  <p-card header="Wypełnione egzaminy">
    <div style="margin-block: .5rem">
      <p-select-button [options]="['normal', 'trash']" (onChange)="changeResponsesMode($event)" [ngModel]="responsesMode" [allowEmpty]="false">
        <ng-template let-option #item>
          @switch (option) {
            @case ('normal') {
              <i class="pi pi-book"></i>
              <span>Aktywne</span>
              <p-badge [value]="responsesCounts.normal" severity="info" />
            }
            @case ('trash') {
              <i class="pi pi-trash"></i>
              <span>Usunięte</span>
              <p-badge [value]="responsesCounts.trash" severity="danger" />
            }
          }
        </ng-template>
      </p-select-button>
    </div>
    @if (responsesMode == 'trash') {
      <div style="margin-bottom: 1rem">
        <p-message severity="error">
          <i class="pi pi-exclamation-triangle" style="font-size: 2.5rem"></i>
          <div style="margin-left: .5rem">
            <p>Tutaj są widoczne wszystkie usunięte egzaminy, które możesz jeszcze przywrócić.</p>
            <p>Egzaminy, które są tutaj widoczne zostaną <b>permanentnie</b> usunięte po 180 dniach od przeniesienia ich do kosza.</p>
          </div>
        </p-message>
      </div>
    }
    <p-table [(first)]="responsesPage" [value]="responsesData" [paginator]="true" [rows]="10" [alwaysShowPaginator]="false">
      <ng-template #header>
        <tr>
          <th style="width: 55px">ID</th>
          <th>Imię i nazwisko</th>
          <th style="width: 150px; text-align: center">Wynik</th>
          <th style="width: 112px; text-align: center">Punkty</th>
          @if (responsesMode == 'trash') {
            <th style="width: 0; text-align: center; white-space: nowrap">Zniknie za</th>
          }
          <th style="width: 0; text-align: center">Akcje</th>
        </tr>
      </ng-template>
      <ng-template #body let-response let-i="rowIndex">
        <tr>
          @if (response.loading) {
            <td colspan="5">
              <div style="display: flex; justify-content: center; align-items: center; gap: 1rem">
                <p-progress-spinner strokeWidth="5" fill="transparent" animationDuration="1s" [style]="{ width: '32px', height: '32px' }" />
                <span style="font-size: 1.25rem; font-weight: 500">Ładowanie...</span>
              </div>
            </td>
          }
          @else if (response.empty) {
            <td colspan="6" style="text-align: center">
              <span style="font-size: 1.25rem; font-weight: 500">Brak wyników</span>
            </td>
          }
          @else {
            <td><b>{{ i + 1 }}</b></td>
            <td>{{ response.student_name }} {{ response.student_surname }}</td>
            <td>
              <p-message [severity]="!response.finished ? 'warn' : (response.passed ? 'success': 'error')">
                @if (!response.finished) {
                  W trakcie
                }
                @else if (response.passed) {
                  Pozytywny
                } @else {
                  Negatywny
                }
              </p-message>
            </td>
            <td style="text-align: center">
              @if (response.finished) {
                <b>{{response.score}}/{{response.max_score}}</b><br />({{(response.score/response.max_score * 100).toFixed(2)}}%)
              }
              @else {
                <b>-/{{response.max_score}}</b><br />(-,--%)
              }
            </td>
            @if (responsesMode == 'trash') {
              <td style="text-align: center">
                @if (response.deleted_at) {
                  {{ getRemovalText(response.deleted_at) }}
                }
                @else {
                  <span class="p-text-secondary">Brak</span>
                }
              </td>
            }
            <td style="white-space: nowrap">
              <div class="actions">
                @if (responsesMode == 'normal') {
                  <p-button severity="info" icon="pi pi-eye" (onClick)="showResponse(response.uuid)" class="p-button-rounded p-button-outlined" />
                }
                @else {
                  <p-button severity="success" icon="pi pi-replay" (onClick)="restoreResponse(response.uuid)" class="p-button-rounded p-button-outlined" />
                }
                <p-button severity="danger" icon="pi pi-trash" (onClick)="deleteResponse(response.uuid)" class="p-button-rounded p-button-outlined" [disabled]="!response.finished" />
              </div>
            </td>
          }
        </tr>
      </ng-template>
    </p-table>
  </p-card>
}
@else {
  <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; flex-direction: column; margin-top: 2rem">
    <p-progress-spinner strokeWidth="5" fill="transparent" animationDuration="1s" [style]="{ width: '128px', height: '128px' }" />
    <span style="font-size: 1.25rem; font-weight: 500">Ładowanie...</span>
  </div>
}
